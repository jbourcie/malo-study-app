rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function role() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    function isParent() { return signedIn() && role() == 'parent'; }
    function isOwner(userId) { return signedIn() && request.auth.uid == userId; }

    // Bibliothèque d'exercices: lecture pour connectés
    match /subjects/{id} { allow read: if signedIn(); allow write: if isParent(); }
    match /themes/{id}    { allow read: if signedIn(); allow write: if isParent(); }
    match /exercises/{id} { allow read: if signedIn(); allow write: if isParent(); }
    match /readings/{id}  { allow read: if signedIn(); allow write: if isParent(); }
    match /questionPacks/{id} { allow read: if signedIn(); allow write: if isParent(); }
    match /questions/{id} {
      allow read: if signedIn() && (isParent() || (resource.data != null && resource.data.quality.status == 'published'));
      allow write: if isParent();
    }

    // Profils utilisateurs
    match /users/{userId} {
      allow read: if isOwner(userId) || isParent();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isParent();

      match /attempts/{attemptId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /attemptItems/{itemId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /stats/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      // Journaux journaliers (chemin : statsDays/{dateKey})
      match /statsDays/{dateKey} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /tagProgress/{tagId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /progressSummary/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /visibilityThemes/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId) || isParent();
      }
      match /visibilityExercises/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId) || isParent();
      }
      match /meta/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /rewardEvents/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
      match /inventory/{docId} {
        allow read: if isOwner(userId) || isParent();
        allow write: if isOwner(userId);
      }
    }
  }
}
